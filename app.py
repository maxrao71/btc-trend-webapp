
import streamlit as st
import pandas as pd
import plotly.graph_objects as go
import numpy as np

st.set_page_config(layout="wide")
st.title("BTC 趨勢圖（離線資料版）")

def get_local_data():
    data = [[1750332191122, 59570.42598823733, 59999.41186091318, 59254.79912894368, 59574.312077651164, 72.36622028210206, '', '', '', '', '', ''], [1750335791122, 60034.92117700898, 60058.4980037866, 59964.23901485677, 60055.6144641957, 89.82751912609591, '', '', '', '', '', ''], [1750339391122, 59237.74368573772, 59388.58552409895, 58962.549877244564, 59013.81205161591, 22.80198818113542, '', '', '', '', '', ''], [1750342991122, 59174.08290199115, 59610.232797833756, 58740.85560209125, 58784.76646849637, 16.564751548833094, '', '', '', '', '', ''], [1750346591122, 60039.03707191902, 60263.114687129244, 59729.62571411127, 59925.200843167826, 47.81472588230407, '', '', '', '', '', ''], [1750350191122, 59686.266653921506, 59747.99844635087, 59330.01781421018, 59521.914709347, 24.067281182833945, '', '', '', '', '', ''], [1750353791122, 60234.09776774818, 60580.30882585992, 59747.01822872413, 60141.95893306557, 70.88463151408294, '', '', '', '', '', ''], [1750357391122, 59492.90529930089, 59732.515103717305, 59083.865094253946, 59521.110332422766, 48.65828071666186, '', '', '', '', '', ''], [1750360991122, 60879.45055780201, 61289.080454101946, 60704.81839569564, 60995.662972825114, 46.94158301672315, '', '', '', '', '', ''], [1750364591122, 59263.40670744757, 59697.02331888896, 58855.59513237851, 59029.196094955194, 18.857805383444656, '', '', '', '', '', ''], [1750368191122, 59508.87173743275, 59630.33677219845, 59030.672190213394, 59478.065606045675, 24.706321174188005, '', '', '', '', '', ''], [1750371791122, 60915.125983718746, 61092.395835435185, 60873.07887392054, 60934.13034566289, 17.175163299650574, '', '', '', '', '', ''], [1750375391122, 60583.45558357517, 60666.18786307405, 60199.47314153588, 60296.619102908524, 84.6963057940531, '', '', '', '', '', ''], [1750378991122, 60436.18437921793, 60882.796404093344, 60145.61276642518, 60370.06104868956, 95.235692354536, '', '', '', '', '', ''], [1750382591122, 59968.39614657401, 60119.663907695474, 59570.938352186145, 59861.73893596847, 45.740090841157084, '', '', '', '', '', ''], [1750386191122, 60952.359153082936, 61202.632658342874, 60614.12383354872, 60916.52462249125, 60.936666907236756, '', '', '', '', '', ''], [1750389791122, 59180.35969323007, 59558.067993626246, 58965.7477060339, 59241.12988547527, 86.64673496970855, '', '', '', '', '', ''], [1750393391122, 60011.35879589481, 60022.19071218647, 59653.1423258886, 59665.75987870226, 35.62152547570059, '', '', '', '', '', ''], [1750396991122, 60470.16449843313, 60604.09208927126, 60098.90012129235, 60520.12343498441, 23.852227586638445, '', '', '', '', '', ''], [1750400591122, 60539.82540562928, 61012.928296736005, 60283.29643024473, 60807.29684352438, 60.34260508987457, '', '', '', '', '', ''], [1750404191122, 59428.084057197244, 59706.092893679604, 59097.846081481206, 59493.1057889686, 57.457661215620014, '', '', '', '', '', ''], [1750407791122, 59384.34468720686, 59513.349371895, 59172.92641799724, 59297.446231904956, 21.065379678042333, '', '', '', '', '', ''], [1750411391122, 59149.54166680514, 59349.91429168752, 59122.47014461027, 59130.54942747812, 93.38823186642506, '', '', '', '', '', ''], [1750414991122, 59543.59849709651, 59836.89340467971, 59347.842911509586, 59690.4524561694, 76.39650312886184, '', '', '', '', '', ''], [1750418591122, 60691.5336237814, 60944.11398888564, 60583.81509928974, 60671.19926963389, 49.34117530048621, '', '', '', '', '', ''], [1750422191122, 60745.466242074006, 60906.11074797116, 60603.184133175244, 60866.91347168177, 15.821909878019714, '', '', '', '', '', ''], [1750425791122, 60539.302916179695, 60767.20692179795, 60518.57708764018, 60623.80710448584, 52.14127534756187, '', '', '', '', '', ''], [1750429391122, 59703.20131424778, 60079.24839641733, 59659.06265719952, 59730.76869022483, 29.62308337456126, '', '', '', '', '', ''], [1750432991122, 59873.656791771464, 59917.58079459839, 59466.370290749284, 59782.26820381163, 15.062457416509698, '', '', '', '', '', ''], [1750436591122, 59712.25621094789, 59912.051829438424, 59520.09126015981, 59843.16914258643, 75.01479397823476, '', '', '', '', '', ''], [1750440191122, 60385.68871653352, 60687.67652895146, 59887.05817571503, 60101.78086921111, 96.73043874510557, '', '', '', '', '', ''], [1750443791122, 60751.71090051206, 61130.22080697539, 60555.089842295696, 60758.708643899045, 47.81720215975549, '', '', '', '', '', ''], [1750447391122, 60246.97602139827, 60674.24968134942, 60039.58216478169, 60290.510582900795, 26.43737977552101, '', '', '', '', '', ''], [1750450991122, 59446.41748081652, 59516.146751254826, 59097.47714163343, 59511.29354093225, 44.92991874745235, '', '', '', '', '', ''], [1750454591122, 59300.46935424204, 59621.36346779551, 58989.76238437865, 59031.60272921218, 44.67965445809156, '', '', '', '', '', ''], [1750458191122, 60260.31694705701, 60671.57331554776, 59827.758681433916, 60432.866044530856, 62.82661867879091, '', '', '', '', '', ''], [1750461791122, 60256.515912316434, 60386.175159358376, 59784.497890460814, 60251.78052987572, 53.64651720967024, '', '', '', '', '', ''], [1750465391122, 59338.909577097846, 59669.64660902766, 59267.69432990783, 59501.70339739162, 75.26920687419194, '', '', '', '', '', ''], [1750468991122, 59223.91663226345, 59608.60177228668, 59126.901761201305, 59228.619842110806, 39.59985276418107, '', '', '', '', '', ''], [1750472591122, 59594.646920111285, 59765.87658916415, 59172.342927222315, 59185.737766876744, 23.847074606014864, '', '', '', '', '', ''], [1750476191122, 60766.41804928681, 60837.58521545276, 60304.615126796256, 60402.408747515656, 65.2635674388184, '', '', '', '', '', ''], [1750479791122, 60399.90801386454, 60448.56298105271, 60371.1909680516, 60379.792312001715, 34.22004354334965, '', '', '', '', '', ''], [1750483391122, 59770.31689010138, 60080.016755824465, 59507.77737809068, 59722.569965500494, 26.882235723479052, '', '', '', '', '', ''], [1750486991122, 60667.46564408673, 60670.35517367131, 60574.10489912705, 60609.43763468941, 73.95441227485338, '', '', '', '', '', ''], [1750490591122, 60254.31783740918, 60708.76921261754, 60181.506418310266, 60489.224571926956, 18.212902045189203, '', '', '', '', '', ''], [1750494191122, 59623.688025810116, 59714.870830558626, 59617.44654856239, 59709.22199687902, 88.97337002880408, '', '', '', '', '', ''], [1750497791122, 60013.54631240187, 60126.9842439748, 59982.65169322193, 60068.55691731925, 94.05797896954452, '', '', '', '', '', ''], [1750501391122, 59911.824432172114, 60215.40192208466, 59487.78235413297, 59824.93076053581, 91.57836727204305, '', '', '', '', '', ''], [1750504991122, 59291.41058224195, 59382.59880520127, 59156.66853803027, 59209.67887310076, 93.09082098354428, '', '', '', '', '', ''], [1750508591122, 60907.31758106391, 61271.30721737329, 60619.82515881513, 60746.023003944356, 46.35796570010537, '', '', '', '', '', ''], [1750512191122, 59371.210212901424, 59663.72135220134, 58988.28947143078, 59179.148802478565, 27.480455350264332, '', '', '', '', '', ''], [1750515791122, 60768.091069152586, 61152.53334195462, 60599.687315981035, 60682.62870764054, 64.74999274811194, '', '', '', '', '', ''], [1750519391122, 60780.57108802847, 61174.8129766835, 60532.97829507479, 60922.92533152478, 27.935748699624757, '', '', '', '', '', ''], [1750522991122, 59367.682754137495, 59421.248349709815, 59282.73910762102, 59296.97550313913, 70.52316031106004, '', '', '', '', '', ''], [1750526591122, 60230.398301192625, 60368.65537092002, 59899.70082154132, 60087.48953316433, 83.31803782378421, '', '', '', '', '', ''], [1750530191122, 59633.041254268814, 60107.647511837386, 59160.198903697375, 59335.40084633051, 86.06019509743956, '', '', '', '', '', ''], [1750533791122, 60411.41339780691, 60458.87163875072, 60099.92142892738, 60368.10296282589, 18.203484853140218, '', '', '', '', '', ''], [1750537391122, 60647.563873679755, 61005.505063836434, 60615.66946028683, 60821.40524304213, 80.52556243383015, '', '', '', '', '', ''], [1750540991122, 59130.25104523738, 59291.756617109, 58728.2484233842, 59258.55528150816, 34.27676034284668, '', '', '', '', '', ''], [1750544591122, 59664.07237754196, 59997.78684830981, 59362.58122067049, 59898.32076778677, 28.105485982478026, '', '', '', '', '', ''], [1750548191122, 59266.96507330984, 59642.86150155874, 58915.96848904324, 59318.98638292402, 66.44389506865004, '', '', '', '', '', ''], [1750551791122, 60162.33382108734, 60576.88818177167, 59866.40421634183, 60565.77143324798, 85.5001688955788, '', '', '', '', '', ''], [1750555391122, 60022.46810253026, 60136.471931780434, 59590.836247616426, 60007.03402757734, 23.750583444077723, '', '', '', '', '', ''], [1750558991122, 59769.834262457676, 59866.75038196852, 59431.36035929795, 59853.44221144026, 52.062191205191965, '', '', '', '', '', ''], [1750562591122, 60332.84012806741, 60760.45319460975, 60320.97431469944, 60349.34809299275, 18.063479372960302, '', '', '', '', '', ''], [1750566191122, 60614.03252292885, 60649.0280303057, 60569.049246693285, 60622.17998756564, 84.46386865228042, '', '', '', '', '', ''], [1750569791122, 60130.30780361187, 60411.915198688235, 59663.104457260866, 59767.80010266407, 93.77993097961608, '', '', '', '', '', ''], [1750573391122, 60081.63776038553, 60572.48904779844, 59874.79967567725, 59898.80821363802, 29.33722015820364, '', '', '', '', '', ''], [1750576991122, 60303.389029296355, 60601.198600857926, 60291.374121473134, 60361.40041947653, 96.61069098767909, '', '', '', '', '', ''], [1750580591122, 59688.242933598034, 59793.21901553906, 59328.26843255697, 59692.664064624456, 15.9496488628327, '', '', '', '', '', ''], [1750584191122, 59317.87693361325, 59461.255269331654, 59292.08733863764, 59403.0271310247, 82.13249208762244, '', '', '', '', '', ''], [1750587791122, 60691.67116696009, 60965.602933885195, 60322.00501331002, 60381.69009046882, 48.180122529009715, '', '', '', '', '', ''], [1750591391122, 60514.15936680067, 60808.02527345027, 60296.572447085135, 60314.92938611173, 34.71458846032894, '', '', '', '', '', ''], [1750594991122, 59120.7963524759, 59177.354014693236, 58957.73153096257, 59017.1920420362, 35.49173806921189, '', '', '', '', '', ''], [1750598591122, 60500.38832906159, 60921.51973476699, 60112.62669894832, 60141.334428806884, 77.84177621987862, '', '', '', '', '', ''], [1750602191122, 59542.24503696812, 59801.019517705034, 59480.34184651836, 59505.01468176064, 67.37807451730055, '', '', '', '', '', ''], [1750605791122, 60140.22137981328, 60311.24350806029, 59942.475110734435, 60246.1242406828, 84.71699416763896, '', '', '', '', '', ''], [1750609391122, 60122.11692689478, 60383.74822987287, 60057.589738838156, 60105.90200445593, 93.47612416077942, '', '', '', '', '', ''], [1750612991122, 60427.319540155906, 60654.39322550007, 60255.72707500711, 60576.38559802765, 98.4845996899226, '', '', '', '', '', ''], [1750616591122, 60752.75434053897, 61125.601625954376, 60681.110498281334, 60941.70958495697, 54.11670682852318, '', '', '', '', '', ''], [1750620191122, 60999.69505604941, 61215.6495755589, 60936.527817383125, 61044.32412857802, 91.62330751103346, '', '', '', '', '', ''], [1750623791122, 60692.77984129242, 61127.775081248226, 60242.22714399914, 61102.56902742239, 67.92255867512043, '', '', '', '', '', ''], [1750627391122, 59104.005698305205, 59157.490139456735, 59019.541096068664, 59102.17861581716, 61.28905981826945, '', '', '', '', '', ''], [1750630991122, 60725.964098515076, 60808.977398212126, 60506.468535947955, 60619.3765356238, 59.96354196884602, '', '', '', '', '', ''], [1750634591122, 59008.59792113822, 59460.79386412392, 58807.949966894856, 59333.283626316355, 49.121150902159684, '', '', '', '', '', ''], [1750638191122, 60572.292507620325, 60835.978035132786, 60553.81766514621, 60751.95680406343, 15.209974450619068, '', '', '', '', '', ''], [1750641791122, 59474.34166420076, 59661.40387505871, 59185.6586417816, 59545.617643401856, 94.36854029038453, '', '', '', '', '', ''], [1750645391122, 60200.45080934724, 60479.00506915546, 60188.733926412584, 60430.72892751175, 32.81037339958105, '', '', '', '', '', ''], [1750648991122, 60919.6142083207, 60973.92431377515, 60886.94770223191, 60911.51398963666, 39.24213623017902, '', '', '', '', '', ''], [1750652591122, 59945.779758674624, 60406.725542225926, 59554.09148742541, 60021.05941089566, 85.8299811367156, '', '', '', '', '', ''], [1750656191122, 59041.85629803462, 59356.65146606589, 59038.837554466074, 59174.97570062197, 92.50705025730186, '', '', '', '', '', ''], [1750659791122, 59896.701294849365, 60269.02480134878, 59864.96455181817, 60162.2080580338, 71.10004047709681, '', '', '', '', '', ''], [1750663391122, 59940.22166114163, 59989.905368509106, 59607.62559948661, 59609.58684262611, 72.92825436079208, '', '', '', '', '', ''], [1750666991122, 59725.335373698945, 60142.16987933288, 59676.0139388103, 59754.134577961355, 34.73079407452924, '', '', '', '', '', ''], [1750670591122, 60377.73507165926, 60839.11069625161, 60096.95728879443, 60296.26170519446, 38.265108486720784, '', '', '', '', '', ''], [1750674191122, 59211.871173078194, 59633.02340431781, 58816.98524210905, 59241.76383112167, 47.38242059397714, '', '', '', '', '', ''], [1750677791122, 59309.00346870873, 59641.90881644804, 59278.80258159953, 59373.87131054216, 64.24255159429299, '', '', '', '', '', ''], [1750681391122, 59406.67733549001, 59772.99796110427, 59368.603402807836, 59661.18235793423, 65.77156852913674, '', '', '', '', '', ''], [1750684991122, 59077.82793271728, 59463.21831425619, 58754.20875613684, 58977.60432275438, 67.51476445866001, '', '', '', '', '', ''], [1750688591122, 60696.92490705787, 60777.41852074826, 60231.57695253222, 60703.235548106975, 12.01483887354847, '', '', '', '', '', '']]
    df = pd.DataFrame(data, columns=[
        'timestamp', 'open', 'high', 'low', 'close', 'volume',
        '_1', '_2', '_3', '_4', '_5', '_6'
    ])
    df['timestamp'] = pd.to_datetime(df['timestamp'], unit='ms')
    df[['open', 'high', 'low', 'close']] = df[['open', 'high', 'low', 'close']].astype(float)
    return df

df = get_local_data()
fig = go.Figure()

fig.add_trace(go.Candlestick(
    x=df['timestamp'],
    open=df['open'],
    high=df['high'],
    low=df['low'],
    close=df['close'],
    increasing_line_color='lime',
    decreasing_line_color='red',
    name='K線'
))

lookback = 20
if len(df) >= lookback:
    x = np.arange(lookback)
    y = df['close'][-lookback:].values
    if len(x) == len(y):
        coef = np.polyfit(x, y, 1)
        trend_line = np.poly1d(coef)(x)

        slope = coef[0]
        trend_desc = "上升趨勢 📈" if slope > 0 else "下降趨勢 📉"
        st.subheader(f"趨勢偵測結果：{trend_desc}（斜率：{slope:.2f}）")

        latest_price = df['close'].iloc[-1]
        latest_trend = trend_line[-1]
        signal_type = None
        if latest_price > latest_trend * 1.01:
            signal_type = 'buy'
        elif latest_price < latest_trend * 0.99:
            signal_type = 'sell'

        trend_x = df['timestamp'][-lookback:]
        fig.add_trace(go.Scatter(
            x=trend_x,
            y=trend_line,
            mode='lines',
            line=dict(color='yellow', width=3),
            name='趨勢線'
        ))

        
    notification_msg = ""
    if signal_type == 'buy':
        notification_msg = "📢 偵測到進場訊號，建議觀察趨勢是否延續"

            fig.add_trace(go.Scatter(
                x=[df['timestamp'].iloc[-1]],
                y=[latest_price],
                mode='markers',
                marker=dict(color='lime', size=12, symbol='circle'),
                name='進場點'
            ))
        
    elif signal_type == 'sell':
        notification_msg = "⚠️ 偵測到出場訊號，請注意風險控管"

            fig.add_trace(go.Scatter(
                x=[df['timestamp'].iloc[-1]],
                y=[latest_price],
                mode='markers',
                marker=dict(color='red', size=12, symbol='circle'),
                name='出場點'
            ))

fig.update_layout(
    plot_bgcolor='black',
    paper_bgcolor='black',
    font=dict(color='white'),
    xaxis_rangeslider_visible=False,
    title="BTC 模擬資料 K 線圖（含趨勢線與進出場提示）"
)


    st.plotly_chart(fig, use_container_width=True)

    # 顯示模擬通知訊息
    if 'notification_msg' in locals() and notification_msg:
        st.markdown(f"### 🔔 通知提醒：{notification_msg}")

